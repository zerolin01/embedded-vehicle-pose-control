# 嵌入式移动小车姿态矫正控制软件 V1.0

基于 H30 惯性姿态模块的移动小车航向保持与自动避障控制系统。

## 📋 项目简介

本项目实现了一套完整的移动小车姿态矫正控制系统，通过 H30 惯性姿态模块提供的欧拉角与角速度数据，实现高精度的航向保持、定角转弯与超声波避障功能。

### 主要特性

- ✅ **H30 姿态感知**：I2C 通信，自适应地址探测（0x35/0x6A/0x6B）
- ✅ **航向保持**：基于 PID 差速控制，支持振荡检测与大误差处理
- ✅ **定角转弯**：原地旋转，舵机联动，保持物品相对地面静止
- ✅ **超声波避障**：HC-SR04，连续 3 次检测 < 6cm 自动停车等待
- ✅ **四轮麦克纳姆**：520 直流电机，独立速度控制
- ✅ **双舵机控制**：GPIO 模拟 PWM，角度精确控制

## 🔧 硬件平台

- **主控**：EAM2011 开发板
- **姿态模块**：H30 惯性姿态模块（I2C 接口）
- **电机**：4 × 520 直流电机（麦克纳姆轮）
- **舵机**：2 × SG90/MG90S 舵机
- **传感器**：HC-SR04 超声波测距模块
- **通信**：I2C、UART、GPIO

## 📂 项目结构

```
Final/
├── board/                          # 板级驱动与控制
│   ├── h30.c|h                    # H30 惯性姿态模块驱动
│   ├── my_move.c|h                # 运动控制（航向保持/转弯/避障）
│   ├── dc_motor_control.c|h       # 直流电机高级控制
│   ├── motor_control.c|h          # 电机底层控制
│   ├── servo_control.c|h          # 舵机1控制
│   ├── servo2_control.c|h         # 舵机2控制
│   ├── hcsr04.c|h                 # 超声波避障
│   └── board_delay.c|h            # 延时工具
├── src/
│   └── main.c                     # 主程序（nb() 任务流程）
├── ESWIN_SDK/                     # 平台 SDK（第三方）
└── README.md                      # 本文件
```

## 🚀 快速开始

### 1. 硬件连接

按照 `board/pin_config.h` 配置引脚连接：
- H30 模块：I2C0（SCL/SDA）+ INT（PORTD4）
- 电机：PWM 输出 + 方向控制
- 舵机：PORTC1（舵机1）、PORTC4（舵机2）
- 超声波：PTA31（TRIG）、PTA30（ECHO）

### 2. 编译与烧录

使用配套 SDK 编译工程.

### 3. 运行

上电后自动执行 `nb()` 任务流程：
1. 第一次直行（5.5s，航向保持 + 避障）
2. 右转 90° + 舵机联动
3. 第二次直行（2s）
4. 舵机动作
5. 第三次直行（2s）
6. 第二次右转 90°
7. 第四次直行（5s）
8. 舵机复位

## 📖 核心功能说明

### H30 姿态模块

- **初始化**：自动探测 I2C 地址，支持 0x35/0x6A/0x6B
- **欧拉角读取**：pitch/roll/yaw（°），1e-6 缩放因子
- **角速度读取**：Z 轴角速度（°/s），固定零偏补偿 5.5°/s
- **航向捕获**：静止多次采样求均值，作为参考航向

### 航向保持控制

- **PID 差速控制**：Kp=0.06, Ki=0.002, Kd=0.012
- **死区与滞回**：误差 < 2° 死区，抑制抖动
- **振荡检测**：误差符号频繁变化时降低增益、增加阻尼
- **大误差处理**：误差 > 6° 时禁用积分、重置状态
- **斜率限制**：纠偏输出限幅与变化率限制，平滑控制

### 避障功能

- **超声波测距**：HC-SR04，测量范围 2-400cm
- **避障策略**：连续 3 次检测 < 6cm → 停车等待
- **去抖处理**：上电 500ms 后启用，避免误触发
- **时间统计**：等待时间不计入运动时间

## 📊 性能指标

- **静态漂移**：死区与固定零偏抑制后，航向稳定
- **直行精度**：小扰动下航向误差 < 2°
- **转弯精度**：收尾阈值 1°，1-2s 内稳定
- **避障响应**：< 100ms（3 次检测 @ 30ms 周期）

## 🔬 API 接口

### H30 姿态

```c
bool H30_Init(void);                                    // 初始化
bool H30_ReadEuler(float *p, float *r, float *y);       // 读取欧拉角
bool H30_ReadGzDps(float *gz);                          // 读取角速度
bool H30_CaptureYawOrigin(uint8_t samples, uint16_t delay_ms);  // 捕获参考航向
void H30_ResetYaw(void);                                // 重置航向
float H30_GetYawDeg(void);                              // 获取航向
```

### 运动控制

```c
void MyMove_StraightInit(void);                         // 直行初始化
void MyMove_StraightHoldYawWithObstacleAvoidanceUseTarget(
    float32_t base_speed, uint32_t duration_ms);       // 直行 + 避障
void MyMove_TurnRight90WithServo(
    float32_t base_turn_speed, float32_t stop_deg, 
    uint32_t timeout_ms, uint16_t servo_angle);        // 右转90° + 舵机
void MyMove_SetStraightTarget(float32_t target_yaw_deg);// 设置目标航向
```

## 📝 软件著作权

- **版本**：V1.0
- **日期**：2025.11.02
- **作者**：林木，欲得必行，文明人@江南大学

## 🤝 贡献

本项目为软件著作权登记版本，暂不接受外部贡献。

## 📄 许可证

版权所有 © 2025 林木，欲得必行，文明人@江南大学

---

**版本**: V1.0  
**构建日期**:  2025.11.02
**状态**:  精简版

