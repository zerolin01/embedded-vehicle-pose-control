### 1. 概述
- 软件名称：嵌入式移动小车姿态矫正控制软件 V1.0
- 版本：V1.0
- 主要用途：在移动小车上实现基于 H30 惯性/姿态模块与外部视觉误差输入的姿态估计与矫正控制，完成直行航向保持、定角转弯与位置姿态微调
- 适用场景：室内轨迹行驶、拐弯定位、越障前后姿态修正、对接/入库等

### 2. 运行环境
- 硬件平台：EAM2011 平台及配套开发板、直流电机驱动与舵机执行机构
- 姿态/IMU：H30 惯性姿态模块（I2C 接口，提供欧拉角与角速度）
- 外设：超声波测距（避障）、UART、I2C、PWM 等
- 开发与编译：项目现有工程（见仓库根目录），使用已有 SDK 构建
- 依赖与许可：`ESWIN_SDK/`、平台代码及第三方库仅作为运行依赖，不纳入本软件著作权的"源代码选编"范围

### 3. 系统结构
- 模块划分：
  - 传感采集与姿态来源：`board/h30.c|h`（H30 惯性姿态模块，提供欧拉角与角速度接口）
  - 运动与航向控制（实际使用）：`board/my_move.c|h`（H30 闭环直行、定角转弯、避障与差速纠偏）
  - 电机与执行器：`board/dc_motor_control.*`、`board/motor_control.*`、`board/servo*.*`
  - 避障：`board/hcsr04.*`
  - 主流程示例：`src/main.c`（`nb()` 任务序列）
- 调用关系：
  - H30(I2C) → 欧拉角/角速度 → `my_move` 航向保持/转弯 → 电机/舵机执行

### 4. 数据采集与标定
- H30 I2C 地址自适应探测：优先 7 位 `0x35`，失败回退 `0x6A/0x6B`
- 角速度读取：12 字节块读取（X/Y/Z 各 4B 小端），缩放系数为 `1e-6` 转换至 °/s
- 零偏与死区：默认固定零偏 `5.5°/s`（可调），死区阈值 `0.15°/s` 抑制静止漂移
- 欧拉角读取：单次读取 12 字节，按 pitch/roll/yaw 解析并缩放

### 5. 姿态解算与融合
- 来源：直接使用 H30 模块内部解算欧拉角（pitch/roll/yaw），并以 Z 轴角速度进行积分航向冗余
- 坐标与角度：右手坐标系，角度范围规范化至 [-180°, 180°]
- 稳定性：对误差采用死区、滞回、指数滑动平均（EMA）与斜率限制；在大误差与超时条件下采取停车矫正

### 6. 姿态矫正/控制策略
- 航向保持（`my_move` 核心）：
  - 参考航向固定采样自 H30（静止多次取样求均值），运行中不漂移
  - PID 差速控制：P+D+可选 I；误差死区（2°）与滞回；纠偏输出限幅（与速度相关）与斜率限制
  - 振荡检测与抑制：误差符号频繁变化时降低增益、增加阻尼
  - 大误差处理：超阈值时禁用积分、重置状态
- 定角转弯（带舵机联动）：
  - 基于 H30 实时 yaw 与目标 yaw 的规范化误差 PID 控制，原地旋转（左右轮反向）
  - 收尾阈值 1°、超时保护
  - 舵机与小车同步转动（保持物品相对地面静止）
- 避障集成：
  - 超声波检测（连续 3 次命中 < 6cm 停车等待），去抖与延时启用
  - 等待时间不计入运动时间，障碍消失后恢复直行

### 7. 主要接口与调用
- H30 传感/姿态：
  - `bool H30_Init()`：初始化 I2C 与 H30 模块，进行地址探测
  - `bool H30_ReadGzDps(float *gz)`：读取 Z 轴角速度（°/s）
  - `bool H30_ReadEuler(float *p, float *r, float *y)`：读取欧拉角（°）
  - `void H30_ResetYaw()` / `void H30_UpdateYaw(uint32_t dt_ms)` / `float H30_GetYawDeg()`
  - `bool H30_CaptureYawOrigin(samples, delay_ms)`：捕获参考航向（多次采样均值）
- 运动控制（实际使用）：
  - 直行：`MyMove_StraightInit()`、`MyMove_StraightHoldYawWithObstacleAvoidanceUseTarget(speed, duration)`、`MyMove_SetStraightTarget(targetYaw)`
  - 转弯：`MyMove_TurnRight90WithServo(base, stop, timeout, servoAngle)`、`MyMove_TurnDelta(delta, base, stop, timeout)`
  - 基础动作：`MyMove_ForwardWithDiff(bs, yaw_corr)`、`MyMove_Stop()`、`servo_set_angle(x)`、`servo2_send_pulse(...)`

### 8. 关键流程图（示意）
```mermaid
digraph G {
  rankdir=LR
  H30[I2C H30]
  Euler[欧拉角 P/R/Y]
  GyroZ[角速度 Gz]
  Ref[参考航向捕获]
  PID[渐进纠偏(P+D+I可选)\n死区/滞回/限幅/斜率]
  Move[电机差速控制]
  QR[视觉误差解析]

  H30 -> Euler
  H30 -> GyroZ
  Euler -> Ref
  Ref -> PID
  Euler -> PID
  GyroZ -> PID
  PID -> Move
  QR -> Move
}
```

### 9. 性能与测试（示例口径）
- 静态漂移：死区与固定零偏抑制后，静态积分航向保持稳定
- 直行保持：小扰动下航向误差 < 2°，大扰动触发停车矫正后恢复
- 转弯精度：收尾阈值 1.5°，可在 1–2 s 内稳定
- 避障响应：连续 3 次有效命中后立即停止

### 10. 版本与变更
- V1.0：完成 H30 接入与欧拉角接口；直行航向保持的多阈值渐进式纠偏；定角转弯；视觉误差分支矫正

### 11. 第三方组件
- `ESWIN_SDK/` 平台与驱动（列名与用途，源码不纳入选编）

### 12. 知识产权声明
- 本说明书与“源代码选编”中的原创代码归申请人所有。第三方库保留其原权利。提交登记版本以仓库冻结版本为准，版本号与提交时间应一致。

